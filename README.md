# Telegram-бот для уведомлений о графике отключений

Бот автоматически отслеживает изменения графика отключений электроэнергии на сайте [poweron.loe.lviv.ua](https://poweron.loe.lviv.ua/) и отправляет уведомления пользователям при изменениях для их группы.

## Возможности

- Автоматический парсинг графика каждые 3 минуты
- Уведомления только при изменениях графика
- Поддержка 12 групп (1.1, 1.2, 2.1, 2.2, 3.1, 3.2, 4.1, 4.2, 5.1, 5.2, 6.1, 6.2)
- Антиспам защита (не более 1 сообщения в минуту)
- Украинский интерфейс

## Требования

- **ОС:** Windows 10/11 x64
- **Python:** 3.12.x x64 (допускается 3.11.x x64, но основной таргет — 3.12)
- **Google Chrome:** x64 (или Chromium x64)
- **ChromeDriver:** устанавливается автоматически через undetected-chromedriver

⚠️ **Важно:** Не используйте Python 3.14+ — некоторые пакеты могут требовать компиляции Rust/Cargo.

## Установка (Windows PowerShell)

### 1. Проверка Python 3.12

Откройте PowerShell и выполните:

```powershell
py -0p
```

Вы должны увидеть строку вида `-3.12-...` в списке установленных версий Python.

Если Python 3.12 не установлен:
1. Скачайте установщик с [python.org](https://www.python.org/downloads/)
2. Выберите версию **3.12.x x64**
3. При установке отметьте "Add Python to PATH"

### 2. Создание виртуального окружения

В PowerShell перейдите в директорию проекта и выполните:

```powershell
# Создание venv под Python 3.12
py -3.12 -m venv .venv

# Активация venv
.\.venv\Scripts\Activate.ps1

# Обновление pip
python -m pip install -U pip

# Установка зависимостей
pip install -r requirements.txt
```

**Примечание:** Если при активации venv появляется ошибка о политике выполнения скриптов, выполните:
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### 3. Установка Google Chrome

1. Скачайте и установите [Google Chrome x64](https://www.google.com/chrome/)
2. Убедитесь, что Chrome запускается вручную (проверка установки)
3. ChromeDriver будет установлен автоматически при первом запуске бота

**Если undetected-chromedriver не находит Chrome автоматически:**

Создайте переменную окружения `CHROME_BINARY` с путем к chrome.exe:

```powershell
# Временная переменная (только для текущей сессии)
$env:CHROME_BINARY = "C:\Program Files\Google\Chrome\Application\chrome.exe"

# Или постоянная переменная (для пользователя)
[System.Environment]::SetEnvironmentVariable('CHROME_BINARY', 'C:\Program Files\Google\Chrome\Application\chrome.exe', 'User')
```

Типичные пути к Chrome:
- `C:\Program Files\Google\Chrome\Application\chrome.exe`
- `C:\Program Files (x86)\Google\Chrome\Application\chrome.exe`

### 4. Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```env
TELEGRAM_BOT_TOKEN=ваш_токен_бота
POLL_INTERVAL_SECONDS=180
TIMEZONE=Europe/Uzhgorod
MAX_SEND_PER_MINUTE=1
LOG_LEVEL=INFO
```

**Как получить токен бота:**

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Скопируйте полученный токен в файл `.env` (замените `ваш_токен_бота`)

## Запуск

Убедитесь, что виртуальное окружение активировано:

```powershell
.\.venv\Scripts\Activate.ps1
```

Запустите бота:

```powershell
python main.py
```

Бот запустится и начнет:
- Обрабатывать команды от пользователей
- Парсить сайт каждые 3 минуты
- Отправлять уведомления при изменениях

В логах вы должны увидеть:
- `Бот запущен и готов к работе`
- `Запуск цикла парсинга (интервал: 180 сек)`

## Команды бота

- `/start` - Начать работу и выбрать группу
- `/group` - Изменить группу
- `/status` - Показать текущий график для вашей группы
- `/unsubscribe` - Отключить подписку на уведомления
- `/help` - Показать справку

## Структура проекта

```
.
├── main.py          # Точка входа, запуск бота и цикла парсинга
├── bot.py           # Обработчики команд Telegram бота
├── scraper.py       # Парсинг сайта через Selenium
├── db.py            # Работа с SQLite базой данных
├── utils.py         # Утилиты (хеширование, diff, форматирование)
├── requirements.txt # Зависимости Python (фиксированные версии)
├── README.md        # Этот файл
├── .env             # Переменные окружения (создать самостоятельно)
├── bot.db           # SQLite база данных (создается автоматически)
├── logs/            # Логи приложения
│   └── app.log
└── debug/           # Артефакты при ошибках парсинга
    ├── last.html    # HTML страницы при ошибке
    └── last.png     # Скриншот при ошибке
```

## Логи и отладка

Логи записываются в:
- Консоль (stdout)
- Файл `logs/app.log`

Формат логов: JSON с полями `time`, `level`, `module`, `msg`.

При ошибках парсинга сохраняются артефакты в `debug/`:
- `last.html` - HTML код страницы
- `last.png` - Скриншот страницы

## Настройка

### Интервал проверки

Измените `POLL_INTERVAL_SECONDS` в `.env` (по умолчанию 180 секунд = 3 минуты).

### Антиспам

Измените `MAX_SEND_PER_MINUTE` в `.env` (по умолчанию 1 сообщение в минуту).

### Уровень логирования

Измените `LOG_LEVEL` в `.env`:
- `DEBUG` - подробные логи
- `INFO` - информационные сообщения (по умолчанию)
- `WARNING` - только предупреждения
- `ERROR` - только ошибки

## Устранение неполадок

### Бот не запускается

1. **Проверьте версию Python:**
   ```powershell
   py -0p
   ```
   Должна быть версия 3.12.x или 3.11.x

2. **Убедитесь, что venv активирован:**
   ```powershell
   .\.venv\Scripts\Activate.ps1
   ```

3. **Проверьте установку зависимостей:**
   ```powershell
   pip list
   ```
   Должны быть установлены: aiogram, selenium, undetected-chromedriver, python-dotenv

4. **Проверьте наличие файла `.env` с правильным `TELEGRAM_BOT_TOKEN`**

### Ошибка компиляции Rust/Cargo при установке зависимостей

**Проблема:** При установке `pip install -r requirements.txt` появляются ошибки про Rust/Cargo или компиляцию.

**Причина:** Используется Python 3.14+ или другая версия, которая требует компиляцию некоторых пакетов.

**Решение:**
1. Установите Python 3.12.x x64
2. Удалите старое виртуальное окружение:
   ```powershell
   Remove-Item -Recurse -Force .venv
   ```
3. Пересоздайте venv по инструкции (пункт 2):
   ```powershell
   py -3.12 -m venv .venv
   .\.venv\Scripts\Activate.ps1
   python -m pip install -U pip
   pip install -r requirements.txt
   ```

### Ошибки парсинга

1. **Проверьте, что Chrome установлен:**
   - Запустите Chrome вручную
   - Убедитесь, что это версия x64

2. **Если Chrome не находится автоматически:**
   - Установите переменную окружения `CHROME_BINARY` (см. пункт 3 раздела "Установка")

3. **Проверьте интернет-соединение**

4. **Посмотрите логи в `logs/app.log`**

5. **Проверьте артефакты в `debug/` для анализа структуры страницы:**
   - `debug/last.html` - HTML код страницы
   - `debug/last.png` - Скриншот страницы

### Бот не отправляет уведомления

1. Убедитесь, что вы выбрали группу командой `/group`
2. Проверьте статус подписки командой `/status`
3. Проверьте логи на наличие ошибок
4. Убедитесь, что график для вашей группы был успешно распарсен (проверьте логи)

### База данных не создается

1. Проверьте права на запись в директорию проекта
2. Убедитесь, что файл `bot.db` не заблокирован другим процессом
3. Проверьте логи на наличие ошибок при инициализации БД

## Проверка работоспособности

После запуска `python main.py` проверьте:

1. ✅ Файл `bot.db` создан в корне проекта
2. ✅ В логах есть сообщение "База данных инициализирована"
3. ✅ В логах есть сообщение "Бот запущен и готов к работе"
4. ✅ В логах есть сообщение "Запуск цикла парсинга (интервал: 180 сек)"
5. ✅ В логах появляются сообщения "Начало парсинга сайта..." каждые 3 минуты

## Деплой на VPS Ubuntu 24.04 через Docker

### 1) Установить Docker на VPS

На Ubuntu 24.04 установите Docker Engine и Compose plugin по официальной инструкции Docker.

### 2) Скопировать проект на сервер

Например:
- `git clone <URL_ВАШЕГО_РЕПО>` в нужную папку

### 3) Создать `.env`

В корне проекта на сервере:

```bash
nano .env
```

Содержимое:

```env
TELEGRAM_BOT_TOKEN=...
POLL_INTERVAL_SECONDS=180
TIMEZONE=Europe/Uzhgorod
MAX_SEND_PER_MINUTE=1
LOG_LEVEL=INFO
```

### 4) Запустить контейнер

Перед первым запуском **обязательно создайте файл БД**, иначе Docker может создать папку `bot.db/`, и SQLite упадёт с `unable to open database file`:

```bash
rm -rf bot.db
touch bot.db
chmod 666 bot.db
mkdir -p logs debug tmp
```

```bash
docker compose up -d --build
```

### 5) Логи

```bash
docker compose logs -f --tail=200
```

### 6) Данные/артефакты

- **БД**: `bot.db` (монтируется в контейнер)
- **Логи**: `logs/app.log`
- **Артефакты парсинга**: `debug/last.html`, `debug/last.png`
- **Временные PNG**: `tmp/` (старше 1 дня чистятся при старте приложения)

## Лицензия

Проект создан для личного использования.
